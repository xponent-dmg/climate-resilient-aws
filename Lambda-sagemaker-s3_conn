
âš™ï¸ GOAL

You want to make sure your frontend â†’ backend (Lambda + API Gateway) â†’ ML models (SageMaker + S3) are all correctly connected.

Iâ€™ll explain step-by-step how that flow works, what to check, and how to connect them.


---

ğŸ§­ Step-by-Step Connection Guide

STEP 1ï¸âƒ£ â€“ Understand the Pipeline

Letâ€™s visualize the data flow youâ€™re working with:

[Frontend on Vercel]
       â†“ (HTTPS)
[API Gateway]  â† public entry point
       â†“
[AWS Lambda (FastAPI)]
       â†“
[SageMaker Endpoint] â†’ ML Prediction
       â†“
[S3 Bucket] â†’ fetches/stores model data or results
       â†“
[RDS (PostgreSQL)] â†’ persistent app data

So in short:

Your Lambda acts as the â€œmiddlemanâ€ â€” it receives API requests from your frontend and calls SageMaker for ML predictions.

S3 stores your ML model files and raw/processed data.

RDS stores user, auth, or result data.



---

STEP 2ï¸âƒ£ â€“ Ensure AWS Resources Are Deployed

âœ… You or your teammate should confirm that these AWS resources exist:

Service	Purpose	What to Verify

S3 Buckets	Store model files and raw/processed data	You should see buckets like climate-health-models, climate-health-raw-data, etc.
SageMaker Endpoint	Host trained ML models	In SageMaker Console â†’ Inference â†’ Endpoints â†’ You should see one with status InService.
Lambda Function	Handles API logic	Function is deployed (e.g., climate-resilient-backend), has correct role & permissions.
API Gateway	Public API for frontend	There should be a deployed API mapping your routes to the Lambda.
RDS Instance	Database	PostgreSQL instance running (optional, if youâ€™re not using database parts).



---

STEP 3ï¸âƒ£ â€“ Connect Lambda to SageMaker

Your lambda_handler.py or predictions.py should contain something like this:

import boto3
import json

sagemaker = boto3.client("sagemaker-runtime")

def get_prediction(input_data):
    response = sagemaker.invoke_endpoint(
        EndpointName="climate-health-model",  # ğŸ‘ˆ your SageMaker endpoint name
        Body=json.dumps(input_data),
        ContentType="application/json",
    )
    result = json.loads(response["Body"].read().decode())
    return result

ğŸ” What to check:

The EndpointName matches exactly with your SageMaker endpoint name.

Your Lambda function has IAM permissions:

sagemaker:InvokeEndpoint

s3:GetObject, s3:PutObject


SageMaker endpoint is in the same region as the Lambda.


âœ… Testing:
In AWS Console â†’ Lambda â†’ Test â†’ paste this in as payload:

{
  "temperature": 31,
  "humidity": 78,
  "rainfall": 120
}

If the function runs successfully, youâ€™ll see a prediction output.


---

STEP 4ï¸âƒ£ â€“ Connect Lambda to S3

If the ML models are stored in S3 or results are logged there, you need:

import boto3
import io, pandas as pd

s3 = boto3.client("s3")

def load_model_from_s3(bucket, key):
    obj = s3.get_object(Bucket=bucket, Key=key)
    return pickle.loads(obj["Body"].read())

def save_results_to_s3(df, bucket, key):
    csv_buffer = io.StringIO()
    df.to_csv(csv_buffer)
    s3.put_object(Bucket=bucket, Key=key, Body=csv_buffer.getvalue())

âœ… What to check:

You have S3 bucket names defined as environment variables:

RAW_BUCKET=climate-health-raw-data
PROCESSED_BUCKET=climate-health-processed-data
MODELS_BUCKET=climate-health-models

IAM permissions include:

s3:GetObject

s3:PutObject



âœ… Test:
Run a Lambda test event that reads from S3 and prints output.
If it errors with AccessDenied, fix IAM roles.


---

STEP 5ï¸âƒ£ â€“ Connect Frontend to Lambda via API Gateway

In your frontend (Vercel), set this env variable:

NEXT_PUBLIC_API_URL=https://<your-api-id>.execute-api.<region>.amazonaws.com/prod

In your frontend code:

const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/predictions`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ temperature, humidity, rainfall }),
});

âœ… Check in Browser DevTools (Network tab):

Request URL points to your API Gateway domain.

Response status is 200 with prediction data.

If you see CORS errors â†’ fix by adding:

from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # or your frontend domain
    allow_methods=["*"],
    allow_headers=["*"],
)



---

STEP 6ï¸âƒ£ â€“ Verify Permissions (IAM)

Make sure the Lambdaâ€™s execution role includes:

{
  "Effect": "Allow",
  "Action": [
    "s3:GetObject",
    "s3:PutObject",
    "sagemaker:InvokeEndpoint",
    "rds:*",
    "secretsmanager:GetSecretValue"
  ],
  "Resource": "*"
}

Otherwise, the function might silently fail when trying to reach S3 or SageMaker.


---

STEP 7ï¸âƒ£ â€“ Connect Database (if using RDS)

In your database_aws.py, the connection string should use the RDS endpoint:

SQLALCHEMY_DATABASE_URL = "postgresql://username:password@<rds-endpoint>:5432/climate_health"

âœ… Store credentials in AWS Secrets Manager, not in plain text.
Retrieve them in code like:

import boto3, json

secrets = boto3.client('secretsmanager')
secret = secrets.get_secret_value(SecretId='ClimateHealthDB')
creds = json.loads(secret['SecretString'])


---

STEP 8ï¸âƒ£ â€“ Final Integration Checklist

Layer	Status Check	How

Frontend â†’ API Gateway	âœ… Reachable?	Open the API URL in browser
Lambda â†’ SageMaker	âœ… Responds to invoke?	CloudWatch logs show inference success
Lambda â†’ S3	âœ… Can read/write?	Upload/download test
Lambda â†’ RDS	âœ… Connected?	Check for connection errors in logs
IAM Roles	âœ… All permissions?	Verify via AWS Console
Environment Variables	âœ… All configured?	Check in Lambda > Configuration > Environment Variables



---

ğŸ’¬ Optional â€” Debugging Tips

Use CloudWatch Logs for Lambda â†’ see if model invocation fails.

Check SageMaker Endpoint Logs â†’ make sure itâ€™s returning a response.

If the model is large and Lambda times out â†’ either increase timeout or shift to SageMaker-only inference.



---

ğŸ§© TL;DR Summary

To make your whole system work:

1. âœ… Make sure S3, Lambda, API Gateway, SageMaker, and RDS all exist and are in the same region.


2. âœ… Update Lambdaâ€™s code to call SageMaker endpoints, not local models.


3. âœ… Give Lambda IAM permissions for S3 + SageMaker + Secrets Manager.


4. âœ… Update your frontend to point to API Gateway URL.


5. âœ… Check logs for missing model files or permission issues.




